
//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "task_mqtt_mng.h"

#include "stdlib.h"

/* Kernel */
#include "pthread.h"
#include "time.h"

/* MQTT */
#include "mqttmng.h"
#include "mqttConfig.h"
#include "loggingConfig.h"
//=============================================================================

//=============================================================================
/*--------------------------------- Defines ---------------------------------*/
//=============================================================================

//=============================================================================

//=============================================================================
/*--------------------------------- Globals ---------------------------------*/
//=============================================================================
pthread_mutex_t mutex;
//=============================================================================

//=============================================================================
/*-------------------------------- Prototypes -------------------------------*/
//=============================================================================
static int32_t taskMqttmngInit(void);
static int32_t taskMqttmngInitLock(void);
static int32_t taskMqttmngLock(uint32_t timeout);
static void taskMqttmngUnlock(void);
//=============================================================================

//=============================================================================
/*---------------------------------- Task -----------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void* taskMqttmng(void *param){

    (void)param;

    if( taskMqttmngInit() != 0 ) exit (-1);

    while(1){
        mqttmngRun();
    }
}
//-----------------------------------------------------------------------------
//=============================================================================

//=============================================================================
/*---------------------------- Static functions -----------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
static int32_t taskMqttmngInit(void){
    
    int32_t status;

    taskMqttmngInitLock();

    status = mqttmngInit(MQTT_CONFIG_DEV_ID, taskMqttmngLock, taskMqttmngUnlock);

    return status;
}
//-----------------------------------------------------------------------------
static int32_t taskMqttmngInitLock(void){

    if( pthread_mutex_init(&mutex, NULL) != 0 ){
        LogInfo( ("Failed to initialize mutex.\n\r") );
        return -1;
    }

    return 0;
}
//-----------------------------------------------------------------------------
static int32_t taskMqttmngLock(uint32_t timeout){

    struct timespec t;
    unsigned long nsec;

    clock_gettime(CLOCK_REALTIME, &t);
    
    nsec = (timeout % 1000) * 1000000;

    t.tv_sec += timeout / 1000;
    
    nsec = t.tv_nsec + (timeout % 1000) * 1000000;
    if( nsec >= 1000000000UL ){
        nsec = nsec - 1000000000U;
        t.tv_sec += 1;
    }
    t.tv_nsec = nsec;

    if( pthread_mutex_timedlock(&mutex, &t) != 0 ) return -1;

    return 0;
}
//-----------------------------------------------------------------------------
static void taskMqttmngUnlock(void){

    pthread_mutex_unlock( &mutex );
}
//-----------------------------------------------------------------------------
//=============================================================================
