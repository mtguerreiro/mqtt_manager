
//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "task_svmqtt.h"

#include "stdlib.h"

/* Kernel */
#include "pthread.h"
#include "time.h"

/* SVMQTT */
#include "mqttmng.h"
#include "mqttmngConfig.h"
//=============================================================================

//=============================================================================
/*--------------------------------- Defines ---------------------------------*/
//=============================================================================

//=============================================================================

//=============================================================================
/*--------------------------------- Globals ---------------------------------*/
//=============================================================================
static int32_t svmqttStatus = 1;

pthread_mutex_t mutex;
//static SemaphoreHandle_t mutex;
//=============================================================================

//=============================================================================
/*-------------------------------- Prototypes -------------------------------*/
//=============================================================================
static int32_t taskSvqmttInit(void);
static int32_t taskSvmqttInitLock(void);
static int32_t taskSvmqttLock(uint32_t timeout);
static void taskSvmqttUnlock(void);
//=============================================================================

//=============================================================================
/*---------------------------------- Task -----------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void* taskSvmqtt(void *param){

    LogInfo( ("Initializing SVMQTT...") );

    if( taskSvqmttInit() != 0 ) exit (-1);

    LogInfo( ("SVMQTT initialized.") );

    svmqttStatus = 0;

    while(1){
        mqttmngRun();
    }
}
//-----------------------------------------------------------------------------
int32_t taskSvmqttStatus(void){

    return svmqttStatus;
}
//-----------------------------------------------------------------------------
//=============================================================================

//=============================================================================
/*---------------------------- Static functions -----------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
static int32_t taskSvqmttInit(void){
    
    int32_t status;

    taskSvmqttInitLock();

    status = mqttmngInit(taskSvmqttLock, taskSvmqttUnlock);

    return status;
}
//-----------------------------------------------------------------------------
static int32_t taskSvmqttInitLock(void){

    if( pthread_mutex_init(&mutex, NULL) != 0 ){
        LogInfo( ("Failed to initialize mutex.\n\r") );
        return -1;
    }
    // mutex = xSemaphoreCreateMutex();
    // if( mutex == NULL ) return -1;

    return 0;
}
//-----------------------------------------------------------------------------
static int32_t taskSvmqttLock(uint32_t timeout){

    struct timespec t;
    unsigned long nsec;

    clock_gettime(CLOCK_REALTIME, &t);
    
    nsec = (timeout % 1000) * 1000000;

    t.tv_sec += timeout / 1000;
    
    nsec = t.tv_nsec + (timeout % 1000) * 1000000;
    if( nsec >= 1000000000UL ){
        nsec = nsec - 1000000000U;
        t.tv_sec += 1;
    }
    t.tv_nsec = nsec;

    if( pthread_mutex_timedlock(&mutex, &t) != 0 ) return -1;

    //if( xSemaphoreTake(mutex, timeout) != pdTRUE ) return -1;

    return 0;
}
//-----------------------------------------------------------------------------
static void taskSvmqttUnlock(void){

    pthread_mutex_unlock( &mutex );

    //xSemaphoreGive(mutex);
}
//-----------------------------------------------------------------------------
//=============================================================================
